<p>During the National Day holiday, I worked on a project to use wasmtime to execute CPython virtual machine compiled into WASM/WASI bytecode, and extend it with Host Functions implemented in Python on the host side.</p><p>I’d like to clarify again that this is just a personal project I wanted to work on, without any validation in production environments, just for fun (XDDD</p><span id="more"></span><h2 id="Main-Content"><a href="#Main-Content" class="headerlink" title="Main Content"></a>Main Content</h2><p>First, let’s briefly introduce WASM/WASI. Here, I’ll directly quote an AI-generated brief summary:</p><blockquote><p>WebAssembly (WASM) is a low-level programming language that can run in modern web browsers. It provides near-native performance.<br>WebAssembly System Interface (WASI) is a standard extension of WASM that allows WASM programs to run outside the browser and access system resources.<br>These two technologies aim to improve Web application performance and make WASM available in more environments.</p></blockquote><p>The core advantages of the WASM/WASI technology route are:</p><ol><li>Cross-platform compatibility</li><li>Multi-language support through static compilation</li><li>Security brought by Native Sandbox</li></ol><p>Therefore, WASM/WASI is not only widely used in browsers but is also gradually expanding to the server-side. Scenarios such as Serverless Compute, Database UDF, and Gateway Plugin are gradually being rolled out.</p><p>While reviewing CPython code recently, I suddenly had an idea: what if I use WASM/WASI Runtime to run CPython, and then extend it with Host Functions implemented in Python on the host side? This seems to be helpful for scenarios like data PaaS that allows users to upload custom code. Of course, the main reason is that this idea seems quite interesting.</p><p>Before we continue, let’s thank one person, Brett Cannon, who almost single-handedly completed the support for CPython WASM/WASI. Say thank you to Brett Cannon with me!</p><p>The overall WASM/WASI evolution route of CPython is as follows:</p><ol><li>As early as November 2021, WASM was supported through emscripten, see BPO-40280<a href="#refer-anchor-1"><sup>1</sup></a></li><li>It became an officially supported Tier3 platform in June 2023 (or earlier?)</li><li>It became an officially supported Tier2 platform in March 2024, see GH-116314<a href="#refer-anchor-2"><sup>2</sup></a></li><li>Starting from Python 3.13, the traditional emscripten method of WASM/WASI support will be abandoned</li></ol><p>OK, let’s start by compiling CPython into WASM/WASI bytecode. You need to set up your environment in advance and make sure WASI-SDK is installed. To save time, I directly use the official devcontainer for all operations.</p><p>After setting up the devcontainer with vscode, we can compile by executing <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code>. To save time, I removed the part in wasi.py that pre-compiles CPython:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">build_all</span>(<span class="params">context</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Build everything.&quot;&quot;&quot;</span></span><br><span class="line">    steps = [</span><br><span class="line">            <span class="comment">#configure_build_python,</span></span><br><span class="line">            <span class="comment">#make_build_python,</span></span><br><span class="line">            configure_wasi_python,</span><br><span class="line">            make_wasi_python</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure><p>After compilation, we can run our CPython using <code>cross-build/wasm32-wasi/python.sh</code>. This is actually a wrapper for the WASMTIME command:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">exec</span> /usr/local/bin/wasmtime run --wasm max-wasm-stack=16777216 --wasi preview2 --<span class="built_in">dir</span> /workspaces/cpython-wasi::/ --<span class="built_in">env</span> PYTHONPATH=/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug /workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure><p>We can see that the officially recommended WASM/WASI Runtime is wasmtime, so we’ll use wasmtime for our next steps.</p><p>Since we want to use Host Functions to extend this process later, we’ll rewrite the bash part. Initially, I used wasmtime’s Python binding, and the code looked roughly like this:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> wasmtime <span class="keyword">import</span> Linker, Engine, Store, WasiConfig, Module, FuncType, ValType, _bindings, Config</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_wasi</span>():</span><br><span class="line">    linker = Linker(Engine())</span><br><span class="line">    linker.define_wasi()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> file:</span><br><span class="line">        module = Module(linker.engine, file.read())</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">foor_bar</span>(<span class="params">a, b</span>):</span><br><span class="line">        <span class="keyword">return</span> a + b</span><br><span class="line">    linker.define_func(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;demo&quot;</span>, FuncType([ValType.i32(),ValType.i32()],[ValType.i32()]), foor_bar)</span><br><span class="line">    store = Store(linker.engine)</span><br><span class="line">    config = Config()</span><br><span class="line">    _bindings.wasmtime_config_max_wasm_stack_set(config.ptr(), <span class="number">16777216</span>)</span><br><span class="line">    wasi_config = WasiConfig()</span><br><span class="line">    <span class="comment"># wasi_config.stdin_file = sys.stdin.fileno()</span></span><br><span class="line">    <span class="comment"># wasi_config.stdout_file = sys.stdout.fileno()</span></span><br><span class="line">    <span class="comment"># wasi_config.stderr_file = sys.stderr.fileno()</span></span><br><span class="line">    wasi_config.env = [[<span class="string">&quot;PYTHONPATH&quot;</span>, <span class="string">&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>]]</span><br><span class="line">    wasi_config.inherit_stdout()</span><br><span class="line">    wasi_config.inherit_stderr()</span><br><span class="line">    wasi_config.inherit_stdin()</span><br><span class="line">    wasi_config.preopen_dir(<span class="string">&quot;/workspaces/cpython-wasi&quot;</span>,<span class="string">&quot;/&quot;</span>)</span><br><span class="line">    store.set_wasi(wasi_config)</span><br><span class="line"></span><br><span class="line">    instance=linker.instantiate(store, module)</span><br><span class="line">    instance.exports(store)[<span class="string">&quot;_start&quot;</span>](store)</span><br><span class="line"></span><br><span class="line">test_wasi()</span><br></pre></td></tr></table></figure><p>Since wasmtime’s Python binding is a direct ctype wrapper, many config options are not exposed in the public API (such as using wasmtime_config_max_wasm_stack_set to handle WASM’s stack), which leads to many operations requiring the use of unexposed private APIs. This is too tricky, so I chose to reimplement this set of operations using Rust:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> wasmtime::*;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::preview1::&#123;<span class="keyword">self</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class="number">16777216</span>);</span><br><span class="line">    <span class="keyword">match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class="line">            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class="keyword">mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">env</span>(</span><br><span class="line">                <span class="string">&quot;PYTHONPATH&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class="line">            );</span><br><span class="line">            builder</span><br><span class="line">                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class="line">                    <span class="string">&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                )</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class="string">&quot;--&quot;</span>, <span class="string">&quot;--version&quot;</span>]);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class="line">                &amp;engine,</span><br><span class="line">                <span class="string">&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class="keyword">mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">run</span> = instance</span><br><span class="line">                .get_typed_func::&lt;(), ()&gt;(&amp;<span class="keyword">mut</span> store, <span class="string">&quot;_start&quot;</span>)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            run.<span class="title function_ invoke__">call</span>(&amp;<span class="keyword">mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then we execute the code, success!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@267e91be24fd wasmtime-demo]<span class="comment"># cargo run --release</span></span><br><span class="line">   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class="line">    Finished `release` profile [optimized] target(s) <span class="keyword">in</span> 1.81s</span><br><span class="line">     Running `target/release/wasmtime-demo`</span><br><span class="line">Python 3.14.0a0</span><br></pre></td></tr></table></figure><p>Now let’s extend our CPython. First, note that since dlopen is not supported in WASM/WASI for CPython, we need to modify the Python core itself.</p><p>First, we add a new file in Python’s Modules directory, named <code>demo.c</code>, with the following content:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Python.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">demo</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> PyObject *</span><br><span class="line"><span class="title function_">foo_bar</span><span class="params">(PyObject *self, PyObject *args)</span></span><br><span class="line">&#123;</span><br><span class="line">Py_INCREF(PyExc_TypeError);</span><br><span class="line"><span class="keyword">return</span> PyLong_FromLong((<span class="type">long</span>) demo(<span class="number">1</span>, <span class="number">2</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyMethodDef foomethods[] = &#123;</span><br><span class="line">&#123;<span class="string">&quot;bar&quot;</span>, foo_bar, METH_VARARGS, <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="literal">NULL</span>&#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> PyModuleDef foomodule = &#123;</span><br><span class="line">PyModuleDef_HEAD_INIT,</span><br><span class="line">.m_name = <span class="string">&quot;demo&quot;</span>,</span><br><span class="line">.m_doc = <span class="string">&quot;foo test module&quot;</span>,</span><br><span class="line">.m_size = <span class="number">-1</span>,</span><br><span class="line">.m_methods = foomethods,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">PyMODINIT_FUNC</span><br><span class="line"><span class="title function_">PyInit_demo</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">return</span> PyModule_Create(&amp;foomodule);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then we add a line in <code>Modules/Setup.bootstrap.in</code>:</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">demo demo.c</span><br></pre></td></tr></table></figure><p>Next, we re-execute the command <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code> to generate new WASM/WASI bytecode. Then we change the args part in our previous Rust code to <code>[&quot;--&quot;, &quot;-c&quot;, &quot;import demo; print(demo.bar())&quot;]</code>, and re-execute the code, success!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@267e91be24fd wasmtime-demo]<span class="comment"># cargo run --release</span></span><br><span class="line">   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class="line">    Finished `release` profile [optimized] target(s) <span class="keyword">in</span> 1.73s</span><br><span class="line">     Running `target/release/wasmtime-demo`</span><br><span class="line">3</span><br></pre></td></tr></table></figure><p>Now, we have an extension module, demo.c, but the problem is that the core <code>demo</code> function in our current demo.c is hardcoded. So we need to handle this.</p><p>Typically, in regular practice, we can separate the implementation and definition of functions to facilitate dynamic linking. WASM/WASI is similar, but requires additional handling:</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">int</span> <span class="title function_">demo</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> __<span class="title function_">attribute__</span><span class="params">((</span></span><br><span class="line"><span class="params">    __import_module__(<span class="string">&quot;demo&quot;</span>),</span></span><br><span class="line"><span class="params">    __import_name__(<span class="string">&quot;demo&quot;</span>),</span></span><br><span class="line"><span class="params">))</span>;</span><br></pre></td></tr></table></figure><p>Here, we use extended macro definitions to tell the compiler at compile time that the demo function is imported from the demo module. This way, we can extend it in subsequent Host Functions according to the convention.</p><p>Then we need to modify CPython’s compilation script, adding <code>-Wextra -Wl,--allow-undefined</code> to the compilation parameters.</p><p>Next, re-execute <code>python3 Tools/wasm/wasi.py build -- --config-cache --with-pydebug</code> to generate new WASM/WASI bytecode. At this point, we can first execute <code>python.sh</code>, and we’ll get an error:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Error: failed to run main module `/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm`</span><br><span class="line"></span><br><span class="line">Caused by:</span><br><span class="line">    0: failed to instantiate <span class="string">&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span></span><br><span class="line">    1: unknown import: `demo::demo` has not been defined</span><br></pre></td></tr></table></figure><p>This is as expected.</p><p>So now let’s reprocess our Rust code:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> wasmtime::*;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::preview1::&#123;<span class="keyword">self</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class="number">16777216</span>);</span><br><span class="line">    <span class="keyword">match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class="line">            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class="keyword">mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            linker</span><br><span class="line">                .<span class="title function_ invoke__">func_wrap</span>(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;demo&quot;</span>, |a: <span class="type">i32</span>, b: <span class="type">i32</span>| &#123;</span><br><span class="line">                    (a+b)*<span class="number">10</span></span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">env</span>(</span><br><span class="line">                <span class="string">&quot;PYTHONPATH&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class="line">            );</span><br><span class="line">            builder</span><br><span class="line">                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class="line">                    <span class="string">&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                )</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class="string">&quot;--&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;import demo; print(demo.bar())&quot;</span>]);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class="line">                &amp;engine,</span><br><span class="line">                <span class="string">&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class="keyword">mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">run</span> = instance</span><br><span class="line">                .get_typed_func::&lt;(), ()&gt;(&amp;<span class="keyword">mut</span> store, <span class="string">&quot;_start&quot;</span>)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            run.<span class="title function_ invoke__">call</span>(&amp;<span class="keyword">mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Execute it, and we get the result:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@267e91be24fd wasmtime-demo]<span class="comment"># cargo run --release</span></span><br><span class="line">   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class="line">    Finished `release` profile [optimized] target(s) <span class="keyword">in</span> 1.79s</span><br><span class="line">     Running `target/release/wasmtime-demo`</span><br><span class="line">30</span><br></pre></td></tr></table></figure><p>As expected.</p><p>Alright, now we support Host Functions, and we can modify our logic arbitrarily while adhering to the function signature. But do you remember the title of this article? We want to execute Python-implemented Host Functions. Hmm, although it’s a bit roundabout, it’s not impossible. Let’s directly bring out PyO3 and modify our Rust code as follows:</p><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">use</span> pyo3::prelude::*;</span><br><span class="line"><span class="keyword">use</span> pyo3::types::PyTuple;</span><br><span class="line"><span class="keyword">use</span> wasmtime::*;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::preview1::&#123;<span class="keyword">self</span>&#125;;</span><br><span class="line"><span class="keyword">use</span> wasmtime_wasi::WasiCtxBuilder;</span><br><span class="line"><span class="keyword">fn</span> <span class="title function_">main</span>() &#123;</span><br><span class="line">    <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">config</span> = Config::<span class="title function_ invoke__">new</span>();</span><br><span class="line">    config.<span class="title function_ invoke__">max_wasm_stack</span>(<span class="number">16777216</span>);</span><br><span class="line">    <span class="keyword">match</span> Engine::<span class="title function_ invoke__">new</span>(&amp;config) &#123;</span><br><span class="line">        <span class="title function_ invoke__">Ok</span>(engine) =&gt; &#123;</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">linker</span> = Linker::<span class="title function_ invoke__">new</span>(&amp;engine);</span><br><span class="line">            preview1::<span class="title function_ invoke__">add_to_linker_sync</span>(&amp;<span class="keyword">mut</span> linker, |t| t).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            linker</span><br><span class="line">                .<span class="title function_ invoke__">func_wrap</span>(<span class="string">&quot;demo&quot;</span>, <span class="string">&quot;demo&quot;</span>, |a: <span class="type">i32</span>, b: <span class="type">i32</span>| &#123;</span><br><span class="line">                    Python::<span class="title function_ invoke__">with_gil</span>(|py| &#123;</span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">fun</span>: Py&lt;PyAny&gt; = PyModule::<span class="title function_ invoke__">from_code_bound</span>(</span><br><span class="line">                            py,</span><br><span class="line">                            <span class="string">&quot;def example(*args, **kwargs):</span></span><br><span class="line"><span class="string">                                return (args[0] + args[1])*11&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        )</span><br><span class="line">                        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">                        .<span class="title function_ invoke__">getattr</span>(<span class="string">&quot;example&quot;</span>)</span><br><span class="line">                        .<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">                        .<span class="title function_ invoke__">into</span>();</span><br><span class="line">                        <span class="keyword">let</span> <span class="variable">args</span> = PyTuple::<span class="title function_ invoke__">new_bound</span>(py, &amp;[a, b]);</span><br><span class="line">                        <span class="comment">// cast following to int</span></span><br><span class="line"></span><br><span class="line">                        fun.<span class="title function_ invoke__">call1</span>(py, args).<span class="title function_ invoke__">unwrap</span>().extract::&lt;<span class="type">i32</span>&gt;(py).<span class="title function_ invoke__">unwrap</span>()</span><br><span class="line">                    &#125;)</span><br><span class="line">                &#125;)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            linker.<span class="title function_ invoke__">allow_unknown_exports</span>(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">builder</span> = WasiCtxBuilder::<span class="title function_ invoke__">new</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">inherit_stdio</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">env</span>(</span><br><span class="line">                <span class="string">&quot;PYTHONPATH&quot;</span>,</span><br><span class="line">                <span class="string">&quot;/cross-build/wasm32-wasi/build/lib.wasi-wasm32-3.14-pydebug&quot;</span>,</span><br><span class="line">            );</span><br><span class="line">            builder</span><br><span class="line">                .<span class="title function_ invoke__">preopened_dir</span>(</span><br><span class="line">                    <span class="string">&quot;/workspaces/cpython-wasi&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;/&quot;</span>,</span><br><span class="line">                    wasmtime_wasi::DirPerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                    wasmtime_wasi::FilePerms::<span class="title function_ invoke__">all</span>(),</span><br><span class="line">                )</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            builder.<span class="title function_ invoke__">args</span>(&amp;[<span class="string">&quot;--&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;import demo; print(demo.bar())&quot;</span>]);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">wasi_ctx</span> = builder.<span class="title function_ invoke__">build_p1</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="keyword">mut </span><span class="variable">store</span> = Store::<span class="title function_ invoke__">new</span>(&amp;engine, wasi_ctx);</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">module</span> = Module::<span class="title function_ invoke__">from_file</span>(</span><br><span class="line">                &amp;engine,</span><br><span class="line">                <span class="string">&quot;/workspaces/cpython-wasi/cross-build/wasm32-wasi/python.wasm&quot;</span>,</span><br><span class="line">            )</span><br><span class="line">            .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">instance</span> = linker.<span class="title function_ invoke__">instantiate</span>(&amp;<span class="keyword">mut</span> store, &amp;module).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">let</span> <span class="variable">run</span> = instance</span><br><span class="line">                .get_typed_func::&lt;(), ()&gt;(&amp;<span class="keyword">mut</span> store, <span class="string">&quot;_start&quot;</span>)</span><br><span class="line">                .<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            run.<span class="title function_ invoke__">call</span>(&amp;<span class="keyword">mut</span> store, ()).<span class="title function_ invoke__">unwrap</span>();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_ invoke__">Err</span>(e) =&gt; &#123;</span><br><span class="line">            <span class="built_in">println!</span>(<span class="string">&quot;Error creating engine: &#123;:?&#125;&quot;</span>, e);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Then execute it, and we get the result:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@267e91be24fd wasmtime-demo]<span class="comment"># cargo run --release</span></span><br><span class="line">   Compiling wasmtime-demo v0.1.0 (/workspaces/wasmtime-demo)</span><br><span class="line">    Finished `release` profile [optimized] target(s) <span class="keyword">in</span> 1.75s</span><br><span class="line">     Running `target/release/wasmtime-demo`</span><br><span class="line">33</span><br></pre></td></tr></table></figure><p>OK, we succeeded!</p><h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>This article is actually a Proof of Concept (PoC) for a technical route, verifying the possibility of combining Python and WASI in specific situations. However, it also exposes some problems:</p><ol><li>The lack of dlopen support requires modifying the CPython runtime code itself. However, according to information provided in Brett Cannon’s blog, someone has hacked this part of the code to provide support. It feels like we can follow up on this later.</li><li>The wasmtime Python binding is really difficult to use. We could consider wrapping it once based on PyO3.</li><li>Using Rust to handle wasmtime and PyO3 to call Python code currently has the problem that Python VM objects cannot be shared across threads. We might need to encapsulate a set of channels similar to Golang based on Rust to reuse the virtual machine and pass data.</li></ol><p>However, overall, this PoC is still very interesting. I hope friends can also have fun playing with it.</p><h2 id="References"><a href="#References" class="headerlink" title="References"></a>References</h2><div id="refer-anchor-1"></div><ul><li>[1]. <a href="https://bugs.python.org/issue40280">https://bugs.python.org/issue40280</a></li></ul><div id="refer-anchor-2"></div><ul><li>[2]. <a href="https://github.com/python/cpython/issues/116314">https://github.com/python/cpython/issues/116314</a></li></ul>