<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="重构-grub-并重装内核">重构 grub 并重装内核</h2><h3 id="简介">简介</h3><p>在导出阿里云虚拟机并将其转储在虚拟机平台上时遇到了 <code>dracut-initqueue timeout could not boot</code> 问题，经过与售后工程师的交流整理出了如下解决方案。</p><h3 id="解决方案">解决方案</h3><ol><li>进入虚拟机 grub 模式或阿里云 ECS，使用如下命令检查系统版本，之后关闭虚拟机电源。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /etc/centos-release<br></code></pre></td></tr></table></figure><blockquote><p>注：建议小版本也要记录。</p></blockquote><ol start="2"><li>访问 <a href="https://vault.centos.org/">CentOS Vault Mirror</a> 下载历史版本的 DVD 版本 iso 镜像。</li></ol><blockquote><p>注：目录样例如下 <code>https://vault.centos.org/7.3.1611/isos/x86_64/CentOS-7-x86_64-DVD-1611.iso</code></p></blockquote><ol start="3"><li>进入虚拟机设置页面，挂载光驱并指定刚刚下载的镜像文件。</li><li>进入虚拟机 BIOS 或 UEFI 指定将光驱的启动顺序移动至磁盘前。</li><li>开启虚拟机，选择 <code>Troubleshooting</code> -&gt; <code>Rescue a CentOS Linux system</code> -&gt; <code>1) Continue</code> 。</li></ol><blockquote><p>注：进入交互式命令行后按 <code>1</code> 即可。</p></blockquote><ol start="6"><li>挂载系统镜像和光盘并暂时移除数据盘。</li></ol><p>输入如下命令进入 bash 并暂时移除数据盘：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">chroot</span> /mnt/sysimage<br>vim /etc/fstab<br></code></pre></td></tr></table></figure><p>暂时把文件中 <code>/dev</code> 目录中的内容全部注释。</p><p>使用 <code>lsblk</code> 命令检查并挂载光盘：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">lsblk<br>mount /dev/sr0 /mnt<br>lsblk<br></code></pre></td></tr></table></figure><blockquote><p>注：<code>NAME: sr0 TYPE: rom RM:1</code> 的是光盘，注意在挂载时会提示为只读模式。</p></blockquote><ol start="7"><li>删除并重新安装内核与 boot 分区。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">rm</span> -rf /boot/*<br><span class="hljs-built_in">ls</span> -l /boot/<br>rpm -aq kernel*<br>yum -y remove kernel*<br><span class="hljs-built_in">cd</span> /mnt/Packages<br>yum -y install ./kernel*<br><span class="hljs-built_in">cd</span> /<br>rpm -aq kernel*<br></code></pre></td></tr></table></figure><p>可以检查下两次内核是否有差异，然后重新构建内核映像即可：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">dracut -f<br><span class="hljs-built_in">ls</span> -l /boot<br></code></pre></td></tr></table></figure><p>若 boot 分区能展示内容则证明操作正常。</p><ol start="8"><li>更新 grub</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs bash">grub2-install /dev/sda<br><span class="hljs-built_in">mkdir</span> /boot/grub2<br>grub2-mkconfig -o /boot/grub2/grub.cfg<br></code></pre></td></tr></table></figure><p>之后可以检查启动配置中的内核</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span> /boot/grub2/grub.cfg | grep menuentry<br></code></pre></td></tr></table></figure><p>若 <code>menuentry</code> 和 <code>$menuentry_id_option</code> 中的子版本对应即证明操作正常。</p><ol start="9"><li><p>使用 <code>exit</code> 命令退出至图形化界面，选择 <code>Troubleshooting</code> -&gt; <code>Boot from local drive</code> 进入系统即可正常启动。</p></li><li><p>进入虚拟机设置中，卸载光驱。</p></li></ol>