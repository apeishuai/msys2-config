<link rel="stylesheet" class="aplayer-secondary-style-marker" href="/assets/css/APlayer.min.css"><script src="/assets/js/APlayer.min.js" class="aplayer-secondary-script-marker"></script><h2 id="Leaflet">Leaflet</h2><h3 id="简介">简介</h3><p>Leaflet 是一个交互式的地图库。为了将其对接进入 Next.js 还需要额外安装 React Leaflet 库。</p><h3 id="安装和使用">安装和使用</h3><p>安装依赖库：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">npm install leaflet react-leaflet leaflet-defaulticon-compatibility<br>npm install -D @types/leaflet<br></code></pre></td></tr></table></figure><p>编写 <code>components/Map.tsx</code> ：</p><figure class="highlight typescript"><figcaption><span>tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-string">&quot;use client&quot;</span>;<br><br><span class="hljs-comment">// IMPORTANT: the order matters!</span><br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;leaflet/dist/leaflet.css&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;leaflet-defaulticon-compatibility/dist/leaflet-defaulticon-compatibility.webpack.css&quot;</span>;<br><span class="hljs-keyword">import</span> <span class="hljs-string">&quot;leaflet-defaulticon-compatibility&quot;</span>;<br><br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">MapContainer</span>, <span class="hljs-title class_">Marker</span>, <span class="hljs-title class_">Popup</span>, <span class="hljs-title class_">TileLayer</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react-leaflet&quot;</span>;<br><span class="hljs-keyword">import</span> &#123;<span class="hljs-title class_">LatLngExpression</span>&#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;leaflet&quot;</span>;<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Map</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">const</span> <span class="hljs-attr">position</span>:<span class="hljs-title class_">LatLngExpression</span> = [<span class="hljs-number">51.505</span>, -<span class="hljs-number">0.09</span>]<br><br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">MapContainer</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">center</span>=<span class="hljs-string">&#123;position&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">zoom</span>=<span class="hljs-string">&#123;11&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">scrollWheelZoom</span>=<span class="hljs-string">&#123;true&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">style</span>=<span class="hljs-string">&#123;&#123;</span> <span class="hljs-attr">height:</span> &quot;<span class="hljs-attr">400px</span>&quot;, <span class="hljs-attr">width:</span> &quot;<span class="hljs-attr">600px</span>&quot; &#125;&#125;</span></span><br><span class="hljs-tag"><span class="language-xml">      <span class="hljs-attr">attributionControl</span>=<span class="hljs-string">&#123;false&#125;</span></span></span><br><span class="hljs-tag"><span class="language-xml">    &gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">TileLayer</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">attribution</span>=<span class="hljs-string">&#x27; &#x27;</span></span></span><br><span class="hljs-tag"><span class="language-xml">        <span class="hljs-attr">url</span>=<span class="hljs-string">&quot;https://&#123;s&#125;.tile.openstreetmap.org/&#123;z&#125;/&#123;x&#125;/&#123;y&#125;.png&quot;</span></span></span><br><span class="hljs-tag"><span class="language-xml">      /&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">Marker</span> <span class="hljs-attr">position</span>=<span class="hljs-string">&#123;position&#125;</span>&gt;</span></span><br><span class="language-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Popup</span>&gt;</span></span><br><span class="language-xml">          This Marker icon is displayed correctly with <span class="hljs-tag">&lt;<span class="hljs-name">i</span>&gt;</span>leaflet-defaulticon-compatibility<span class="hljs-tag">&lt;/<span class="hljs-name">i</span>&gt;</span>.</span><br><span class="language-xml">        <span class="hljs-tag">&lt;/<span class="hljs-name">Popup</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;/<span class="hljs-name">Marker</span>&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">MapContainer</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><p>编写 <code>test/page.tsx</code> ：</p><figure class="highlight typescript"><figcaption><span>tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-string">&quot;use client&quot;</span>;<br><br><span class="hljs-keyword">import</span> dynamic <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;next/dynamic&quot;</span>;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyMap</span> = <span class="hljs-title function_">dynamic</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">&quot;@/components/Map&quot;</span>), &#123;<br>  <span class="hljs-attr">ssr</span>: <span class="hljs-literal">false</span>,<br>  <span class="hljs-attr">loading</span>: <span class="hljs-function">() =&gt;</span> <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>,<br>&#125;);<br><br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"></span>) &#123;<br>  <span class="hljs-keyword">return</span> (<br>    <span class="language-xml"><span class="hljs-tag">&lt;<span class="hljs-name">main</span>&gt;</span></span><br><span class="language-xml">      <span class="hljs-tag">&lt;<span class="hljs-name">LazyMap</span> /&gt;</span></span><br><span class="language-xml">    <span class="hljs-tag">&lt;/<span class="hljs-name">main</span>&gt;</span></span><br>  );<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="自定义插件">自定义插件</h3><figure class="highlight typescript"><figcaption><span>tsx</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs typescript"><span class="hljs-keyword">import</span> L <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;leaflet&quot;</span>;<br><span class="hljs-keyword">import</span> &#123;createLayerComponent, <span class="hljs-title class_">LayerProps</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;@react-leaflet/core&quot;</span>;<br><span class="hljs-keyword">import</span> &#123; <span class="hljs-title class_">ReactNode</span> &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;react&quot;</span>;<br><br><span class="hljs-keyword">interface</span> <span class="hljs-title class_">KittenProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LayerProps</span> &#123;<br>  <span class="hljs-attr">userId</span>: <span class="hljs-built_in">string</span>,<br>  children?: <span class="hljs-title class_">ReactNode</span> <span class="hljs-comment">// PropsWithChildren is not exported by @react-leaflet/core</span><br>&#125;<br><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">Kitten</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">L.TileLayer</span> &#123;<br>  <span class="hljs-comment">// </span><br>  <span class="hljs-title function_">getTileUrl</span>(<span class="hljs-params">coords: L.Coords</span>) &#123;<br>    <span class="hljs-keyword">var</span> i = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>( <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">4</span> );<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;https://placekitten.com/256/256?image=&quot;</span> + i;<br>  &#125;<br><br>  <span class="hljs-title function_">getAttribution</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;&lt;a href=&#x27;https://placekitten.com/attribution.html&#x27;&gt;PlaceKitten&lt;/a&gt;&quot;</span><br>  &#125;<br><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">createKittenLayer</span> = (<span class="hljs-params">props: KittenProps, context:<span class="hljs-built_in">any</span></span>) =&gt; &#123;<br>  <span class="hljs-keyword">const</span> instance = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Kitten</span>(<span class="hljs-string">&quot;placeholder&quot;</span>, &#123;...props&#125;);<br>  <span class="hljs-keyword">return</span> &#123;instance, context&#125;;<br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title function_">updateKittenLayer</span> = (<span class="hljs-params">instance: <span class="hljs-built_in">any</span>, props: KittenProps, prevProps: KittenProps</span>) =&gt; &#123;<br>  <span class="hljs-keyword">if</span> (prevProps.<span class="hljs-property">userId</span> !== props.<span class="hljs-property">userId</span>) &#123;<br>    <span class="hljs-keyword">if</span> (instance.<span class="hljs-property">setUserId</span>) instance.<span class="hljs-title function_">setUserId</span>(props.<span class="hljs-property">userId</span>)<br>  &#125;<br><br>&#125;<br><br><span class="hljs-keyword">const</span> <span class="hljs-title class_">KittenLayer</span> = <span class="hljs-title function_">createLayerComponent</span>(createKittenLayer, updateKittenLayer);<br><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">KittenLayer</span>;<br></code></pre></td></tr></table></figure><blockquote><p>注：在使用这种方式之后 IDEA 会报错，但是程序是可以正常运行的，是 leaflet 源码的问题。</p></blockquote><p><a href="https://github.com/sakitam-fdd/wind-layer/blob/master/packages/leaflet/src/layer/Base.ts">参考文件</a></p><h3 id="参考资料">参考资料</h3><p><a href="https://leafletjs.com/">Leaflet</a></p><p><a href="https://react-leaflet.js.org/">React Leaflet</a></p><p><a href="https://stackoverflow.com/questions/77978480/nextjs-with-react-leaflet-ssr-webpack-window-not-defined-icon-not-found">Nextjs with react-leaflet</a></p><p><a href="https://stackoverflow.com/questions/65663826/how-to-extend-tilelayer-component-in-react-leaflet-v3/65713838#65713838">How to extend TileLayer component in react-leaflet v3?</a></p>