
<p>昨天我提交了一个新App，2023年我的计划就是开发一系列的小App试图在独立开发领域有一份收入。但是今天一早就发现被拒绝了。</p>



<p>理由是：</p>



<span id="more-26850"></span>



<blockquote class="wp-block-quote">
<p><strong>Guideline 3.1.1 &#8211; Business &#8211; Payments &#8211; In-App Purchase</strong></p>



<p>We found that your app offers in-app purchases that can be restored but does not include a &#8220;Restore Purchases&#8221; feature to allow users to restore the previously purchased in-app purchases, as specified in the &#8220;Restoring Purchase Products&#8221; section of the <a href="https://developer.apple.com/library/archive/documentation/NetworkingInternet/Conceptual/StoreKitGuide/Introduction.html">In-App Purchase Programming Guide</a>:</p>



<p>&#8220;Users restore transactions to maintain access to content they&#8217;ve already purchased. For example, when they upgrade to a new phone, they don&#8217;t lose all of the items they purchased on the old phone. Include some mechanism in your app to let the user restore their purchases, such as a Restore Purchases button.&#8221;</p>



<p><strong>Next Steps</strong></p>



<p>To restore previously purchased in-app purchase products, it would be appropriate to provide a &#8220;Restore&#8221; button and initiate the restore process when the &#8220;Restore&#8221; button is tapped by the user. Note that automatically restoring purchases on launch will not resolve this issue.</p>
</blockquote>



<p>这段大概可以翻译为：</p>



<blockquote class="wp-block-quote">
<p>准则3.1.1 &#8211; 业务 &#8211; 支付 &#8211; 应用内购买</p>



<p>我们发现你的应用程序提供了可以恢复的应用内购买，但不包括 &#8220;恢复购买 &#8220;功能，以允许用户恢复之前购买的应用内购买，如应用内购买程序指南的 &#8220;恢复购买产品 &#8220;部分所规定的。</p>



<p>&#8220;用户恢复交易以保持对他们已经购买的内容的访问。例如，当他们升级到一个新的手机时，他们不会失去他们在旧手机上购买的所有物品。在你的应用程序中包括一些机制，让用户恢复他们的购买，如恢复购买按钮。&#8221;</p>



<p>接下来的步骤</p>



<p>为了恢复以前购买的应用内产品，应该提供一个 &#8220;恢复 &#8220;按钮，并在用户点击 &#8220;恢复 &#8220;按钮时启动恢复程序。请注意，启动时自动恢复购买的产品不会解决这个问题。</p>
</blockquote>



<p>意思就是，我提供了一个应用内购买功能（付费用户），但是没有提供恢复购买按钮。</p>



<p>我当时就很奇怪，因为我用的是StoreKit2，我记得学习这套新API的原因有两个大点，第一个就是这套新API更简洁，更好用。第二就是，不需要恢复购买的流程了，自动会保持与AppStore购买记录的同步。</p>



<p>我找来当时让我选择了Storekit2的WWDC官方视频“<a href="https://www.youtube.com/watch?v=E5Vz11NyR2g">Meet StoreKit 2 | 10114 | WWDC2021”</a>，里面明确的说了，</p>



<blockquote class="wp-block-quote">
<p>So, all of this means&nbsp;that users won&#8217;t need to restore completed transactions&nbsp;when your app is reinstalled or downloaded on a new device.&nbsp;Everything should automatically be fetched by StoreKit&nbsp;and stay up to date.&nbsp;</p>



<p>因此，所有这些都意味着，当你的应用程序被重新安装或下载到新设备上时，用户将不需要恢复已完成的交易。&nbsp;一切都应该由StoreKit自动获取，并保持最新状态。&nbsp;</p>
</blockquote>



<figure class="wp-block-image size-large"><img decoding="async" loading="lazy" width="1024" height="516" src="https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-1024x516.png" alt="" class="wp-image-26852" srcset="https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-1024x516.png 1024w, https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-300x151.png 300w, https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-768x387.png 768w, https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-1536x773.png 1536w, https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26-1200x604.png 1200w, https://codechina.org/wp-content/uploads/2023/01/截屏2023-01-04-12.20.26.png 1748w" sizes="(max-width: 1024px) 100vw, 1024px" /></figure>



<p>结果，我没注意的是，这句以后，他还说了一句，</p>



<blockquote class="wp-block-quote">
<p>But people use their Apple devices in millions of ways in millions of places.&nbsp;In the rare case that a user thinks&nbsp;they should have a transaction but you don&#8217;t see it,&nbsp;you can use the App Store sync API.&nbsp;This immediately resynchronizes all StoreKit 2 transactions.&nbsp;This is a replacement for the&nbsp;restoreCompletedTransactions API,and you should provide UI in your app that allows users to initiate the sync.&nbsp;However, thanks to StoreKit 2&#8217;s automatic synchronization,&nbsp;it should be very rare&nbsp;that a user needs to initiate a sync manually.&nbsp;</p>



<p>但人们在数百万个地方以数百万种方式使用他们的苹果设备。&nbsp;在罕见的情况下，如果用户认为他们应该有一个交易，但你没有看到它，你可以使用App Store的sync API。&nbsp;这将立即重新同步所有StoreKit 2交易。&nbsp;这是对 restoreCompletedTransactions API 的替代，你应该在你的应用程序中提供允许用户启动同步的用户界面。&nbsp;然而，由于StoreKit 2的自动同步功能，用户需要手动启动同步的情况应该非常少。&nbsp;</p>
</blockquote>



<p>也就是说，虽然，基本上用不上恢复购买按钮，但是我们还是需要提供一个恢复购买按钮，来同步Appstore的购买记录。</p>



<p>而且，审核Guideline也没变，还是要求提供恢复购买按钮。</p>



<p>那能怎么办呢？那就加吧。</p>



<p>在UI的底部加上一段代码，倒是不复杂：</p>



<pre class="wp-block-code"><code lang="swift" class="language-swift">Button {
    Task {
        do {
            try await AppStore.sync()
        } catch {
            print(error)
        }
    }
} label: {
    Text("Restore Purchases")
}
</code></pre>



<p>我本来觉得这个按钮就是蠢的要死。你在别的网络服务买个账号，需要有个按钮明确的恢复购买么？不都是网络化的，有信号就自动更新的东西么。唉，本以为StoreKit2以后就不用放这个愚蠢的按钮，看来还是需要，放就放吧。</p>



<p>我也能理解苹果遇到的问题，总有网络问题，或者用户觉得自己买过，也许是糊涂了，给他一个按钮，让他可以手动恢复，可能会让用户更安心吧。唉。</p>
<p><a rel="nofollow" href="https://codechina.org/2023/01/storekit2-appstore/">使用StoreKit2不再需要恢复购买按钮，但是为了审核你还需要放一个【AppStore审核手记】</a>最先出现在<a rel="nofollow" href="https://codechina.org">Tinyfool的个人网站</a>。</p>
